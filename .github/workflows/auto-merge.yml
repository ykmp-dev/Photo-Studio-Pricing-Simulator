name: Auto PR and Merge

on:
  push:
    branches:
      - 'claude/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Pull Request and Auto Merge
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ブランチ名を取得
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Current branch: $BRANCH_NAME"

          # 既存のPRをチェック
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --base main --json number --jq '.[0].number')

          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists"
            PR_NUMBER=$EXISTING_PR
          else
            echo "Creating new PR..."
            PR_URL=$(gh pr create \
              --title "Auto-merge: $BRANCH_NAME" \
              --body "このPRは自動的に作成・マージされます。Claudeセッション ${BRANCH_NAME} からの変更を自動的にマージします。マージ後、GitHub Pagesに自動デプロイされます。" \
              --base main \
              --head "$BRANCH_NAME")

            PR_NUMBER=$(echo $PR_URL | grep -oP '\d+$')
            echo "Created PR #$PR_NUMBER"
          fi

          # PRを即座にマージ
          echo "Merging PR #$PR_NUMBER..."
          gh pr merge $PR_NUMBER --merge --delete-branch

          echo "✅ PR merged successfully!"
