name: Auto PR and Merge

on:
  push:
    branches:
      - 'claude/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create Pull Request and Auto Merge
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # リトライ関数（指数バックオフ付き）
          retry_command() {
            local max_retries=4
            local retry_delay=2
            local attempt=0
            local exit_code=0

            while [ $attempt -le $max_retries ]; do
              if [ $attempt -gt 0 ]; then
                echo "Retrying in ${retry_delay}s... (attempt $((attempt + 1))/$((max_retries + 1)))"
                sleep $retry_delay
                retry_delay=$((retry_delay * 2))
              fi

              "$@" && return 0
              exit_code=$?
              attempt=$((attempt + 1))
            done

            echo "❌ Command failed after $((max_retries + 1)) attempts"
            return $exit_code
          }

          # ブランチ名を取得
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Current branch: $BRANCH_NAME"

          # 既存のPRをチェック（リトライ付き）
          echo "Checking for existing PRs..."
          EXISTING_PR=$(retry_command gh pr list --head "$BRANCH_NAME" --base main --json number --jq '.[0].number')

          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists"
            PR_NUMBER=$EXISTING_PR
          else
            echo "Creating new PR..."
            PR_URL=$(retry_command gh pr create \
              --title "Auto-merge: $BRANCH_NAME" \
              --body "このPRは自動的に作成・マージされます。Claudeセッション ${BRANCH_NAME} からの変更を自動的にマージします。マージ後、GitHub Pagesに自動デプロイされます。" \
              --base main \
              --head "$BRANCH_NAME")

            PR_NUMBER=$(echo $PR_URL | grep -oP '\d+$')
            echo "Created PR #$PR_NUMBER"
          fi

          # PRがマージ可能か確認（リトライロジック付き）
          echo "Checking if PR #$PR_NUMBER is mergeable..."

          # UNKNOWN状態の場合、最大5回リトライ（各5秒待機）
          MAX_RETRIES=5
          RETRY_COUNT=0
          MERGEABLE="UNKNOWN"

          while [ "$MERGEABLE" = "UNKNOWN" ] && [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if [ $RETRY_COUNT -gt 0 ]; then
              echo "Waiting for GitHub to determine mergeable status... (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
              sleep 5
            fi

            MERGEABLE=$(retry_command gh pr view $PR_NUMBER --json mergeable --jq '.mergeable' || echo "UNKNOWN")
            echo "Mergeable status: $MERGEABLE"
            RETRY_COUNT=$((RETRY_COUNT + 1))
          done

          # まだUNKNOWNの場合、マージを試みる（失敗したらエラーメッセージが出る）
          if [ "$MERGEABLE" = "UNKNOWN" ]; then
            echo "⚠️ Mergeable status is still UNKNOWN after $MAX_RETRIES attempts."
            echo "Attempting to merge anyway..."
          elif [ "$MERGEABLE" != "MERGEABLE" ]; then
            echo "❌ PR #$PR_NUMBER cannot be merged automatically."
            echo "Mergeable status: $MERGEABLE"
            echo "Possible reasons:"
            echo "  - The branch is behind main"
            echo "  - There are merge conflicts"
            echo "  - Required status checks are not passing"
            echo ""
            echo "Please check the PR: https://github.com/${{ github.repository }}/pull/$PR_NUMBER"
            exit 1
          fi

          # PRをマージ（リトライ付き）
          echo "Merging PR #$PR_NUMBER..."
          retry_command gh pr merge $PR_NUMBER --merge --delete-branch

          echo "✅ PR merged successfully!"
