name: Auto PR and Merge with Auto-Fix

on:
  push:
    branches:
      - 'claude/**'

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read
  checks: read
  statuses: read

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create Pull Request and Auto Merge with Auto-Fix
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # GitHub CLI„ÅÆÁ¢∫Ë™ç
          echo "Checking GitHub CLI..."
          gh --version || echo "GitHub CLI version check failed, but continuing..."
          echo ""

          # „É™„Éà„É©„Ç§Èñ¢Êï∞ÔºàÊåáÊï∞„Éê„ÉÉ„ÇØ„Ç™„Éï‰ªò„ÅçÔºâ
          retry_command() {
            local max_retries=4
            local retry_delay=2
            local attempt=0
            local exit_code=0

            while [ $attempt -le $max_retries ]; do
              if [ $attempt -gt 0 ]; then
                echo "Retrying in ${retry_delay}s... (attempt $((attempt + 1))/$((max_retries + 1)))"
                sleep $retry_delay
                retry_delay=$((retry_delay * 2))
              fi

              if "$@"; then
                echo "‚úÖ Command succeeded (attempt $((attempt + 1)))"
                return 0
              fi
              exit_code=$?
              echo "‚ö†Ô∏è Command failed with exit code $exit_code (attempt $((attempt + 1))/$((max_retries + 1)))"
              attempt=$((attempt + 1))
            done

            echo "‚ùå Command failed after $((max_retries + 1)) attempts (final exit code: $exit_code)"
            return $exit_code
          }

          # Ëá™Âãï‰øÆÂæ©Èñ¢Êï∞
          auto_fix_branch() {
            local branch_name=$1
            echo "üîß Attempting auto-fix for branch: $branch_name"

            # main„Éñ„É©„É≥„ÉÅ„ÅÆÊúÄÊñ∞„ÇíÂèñÂæó
            git fetch origin main

            # ÁèæÂú®„ÅÆ„Éñ„É©„É≥„ÉÅ„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà
            git checkout "$branch_name"

            # main„Éñ„É©„É≥„ÉÅ„Çírebase„ÅßÁµ±Âêà„ÇíË©¶„Åø„Çã
            echo "Attempting to rebase onto main..."
            if git rebase origin/main; then
              echo "‚úÖ Rebase successful!"

              # Âº∑Âà∂„Éó„ÉÉ„Ç∑„É•ÔºàrebaseÂæå„ÅØÂøÖË¶ÅÔºâ
              if git push --force-with-lease origin "$branch_name"; then
                echo "‚úÖ Force-pushed rebased branch"
                return 0
              else
                echo "‚ùå Failed to push rebased branch"
                return 1
              fi
            else
              echo "‚ö†Ô∏è Rebase failed, attempting merge strategy..."
              git rebase --abort

              # rebase„ÅåÂ§±Êïó„Åó„ÅüÂ†¥Âêà„ÄÅmerge„ÇíË©¶„Åø„Çã
              if git merge origin/main -m "Auto-merge: Merge main into $branch_name"; then
                echo "‚úÖ Merge successful!"

                if git push origin "$branch_name"; then
                  echo "‚úÖ Pushed merged branch"
                  return 0
                else
                  echo "‚ùå Failed to push merged branch"
                  return 1
                fi
              else
                echo "‚ùå Merge also failed"

                # „Ç≥„É≥„Éï„É™„ÇØ„Éà„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅËá™ÂãïËß£Ê±∫„ÇíË©¶„Åø„ÇãÔºàoursÊà¶Áï•Ôºâ
                echo "‚ö†Ô∏è Attempting conflict resolution with 'ours' strategy..."
                git merge --abort

                if git merge -X ours origin/main -m "Auto-merge: Resolve conflicts with ours strategy"; then
                  echo "‚úÖ Conflicts resolved with 'ours' strategy"

                  if git push origin "$branch_name"; then
                    echo "‚úÖ Pushed conflict-resolved branch"
                    return 0
                  fi
                fi

                echo "‚ùå Auto-fix failed"
                return 1
              fi
            fi
          }

          # issue„Çí‰ΩúÊàê„Åô„ÇãÈñ¢Êï∞
          create_failure_issue() {
            local branch_name=$1
            local error_message=$2

            echo "üìù Creating issue for merge failure..."

            gh issue create \
              --title "üö® Auto-merge failed for branch: $branch_name" \
              --body "## Auto-merge Failure Report

**Branch**: \`$branch_name\`
**Time**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
**Workflow Run**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

### Error
\`\`\`
$error_message
\`\`\`

### What happened?
The auto-merge workflow failed to merge this branch into main.

### Recommended Actions
1. Check for merge conflicts: \`git checkout $branch_name && git merge main\`
2. Resolve conflicts manually if needed
3. Run tests to ensure everything works
4. Manually merge the PR: https://github.com/${{ github.repository }}/pulls

### Auto-fix Attempts
- ‚úÖ Retry with exponential backoff
- ‚úÖ Rebase onto main
- ‚úÖ Merge with main
- ‚úÖ Conflict resolution with 'ours' strategy
- ‚ùå All auto-fix attempts failed

**This issue was automatically created by GitHub Actions.**
" \
              --label "auto-merge-failure,bug"
          }

          # „Éñ„É©„É≥„ÉÅÂêç„ÇíÂèñÂæó
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "========================================="
          echo "Auto-merge workflow started"
          echo "========================================="
          echo "Branch: $BRANCH_NAME"
          echo "Repository: ${{ github.repository }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "========================================="

          # main„Éñ„É©„É≥„ÉÅ„ÅÆÂ≠òÂú®„ÇíÁ¢∫Ë™ç
          echo "Fetching main branch..."
          if ! git fetch origin main:main 2>/dev/null; then
            echo "‚ö†Ô∏è Could not fetch main branch, trying alternative method..."
            git fetch origin main
          fi

          echo "‚úÖ Main branch fetched successfully"

          # Êó¢Â≠ò„ÅÆPR„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºà„É™„Éà„É©„Ç§‰ªò„ÅçÔºâ
          echo "Checking for existing PRs..."
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --base main --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [ -n "$EXISTING_PR" ] && [ "$EXISTING_PR" != "null" ]; then
            echo "‚úÖ PR #$EXISTING_PR already exists"
            PR_NUMBER=$EXISTING_PR
          else
            echo "No existing PR found. Creating new PR..."

            # PR‰ΩúÊàêÂâç„Å´main„Å®„ÅÆÂ∑ÆÂàÜ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            git fetch origin main
            COMMITS_BEHIND=$(git rev-list --count HEAD..origin/main)

            if [ "$COMMITS_BEHIND" -gt 0 ]; then
              echo "‚ö†Ô∏è Branch is $COMMITS_BEHIND commits behind main"
              echo "Attempting to update branch before creating PR..."

              if ! auto_fix_branch "$BRANCH_NAME"; then
                echo "‚ùå Failed to update branch"
                ERROR_MSG="Branch is behind main and auto-fix failed"
                create_failure_issue "$BRANCH_NAME" "$ERROR_MSG"
                exit 1
              fi
            fi

            PR_BODY="„Åì„ÅÆPR„ÅØËá™ÂãïÁöÑ„Å´‰ΩúÊàê„Éª„Éû„Éº„Ç∏„Åï„Çå„Åæ„Åô„ÄÇ

**Branch**: \`$BRANCH_NAME\`
**Changes**: Automated changes from Claude Code session

„Éû„Éº„Ç∏Âæå„ÄÅGitHub Pages„Å´Ëá™Âãï„Éá„Éó„É≠„Ç§„Åï„Çå„Åæ„Åô„ÄÇ

---

### Auto-merge Status
- ‚úÖ PR created automatically
- ‚è≥ Waiting for merge checks
- üîÑ Will auto-merge when ready

**„Åì„ÅÆPR„ÅØËá™ÂãïÁöÑ„Å´‰ΩúÊàê„Åï„Çå„Åæ„Åó„Åü„ÄÇÂïèÈ°å„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÊâãÂãï„ÅßÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ**"

            echo "Attempting to create PR..."
            echo "  Title: Auto-merge: $BRANCH_NAME"
            echo "  Base: main"
            echo "  Head: $BRANCH_NAME"

            # PR‰ΩúÊàêÔºà„Ç®„É©„ÉºÂá∫Âäõ„Çí„Ç≠„É£„Éó„ÉÅ„É£Ôºâ
            PR_CREATE_OUTPUT=$(gh pr create \
              --title "Auto-merge: $BRANCH_NAME" \
              --body "$PR_BODY" \
              --base main \
              --head "$BRANCH_NAME" 2>&1)
            PR_CREATE_STATUS=$?

            if [ $PR_CREATE_STATUS -eq 0 ]; then
              PR_URL="$PR_CREATE_OUTPUT"
              echo "‚úÖ PR created successfully: $PR_URL"
            else
              echo "‚ùå PR creation failed with exit code $PR_CREATE_STATUS"
              echo "Error output:"
              echo "$PR_CREATE_OUTPUT"
              PR_URL=""
            fi

            if [ -z "$PR_URL" ]; then
              echo "‚ùå Failed to create PR"
              ERROR_MSG="Failed to create PR for branch $BRANCH_NAME. Output: $PR_CREATE_OUTPUT"
              create_failure_issue "$BRANCH_NAME" "$ERROR_MSG"
              exit 1
            fi

            # PRÁï™Âè∑„ÇíÊäΩÂá∫ÔºàURL„ÅÆÊúÄÂæå„ÅÆÊï∞Â≠óÔºâ
            PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$' || echo "")
            if [ -z "$PR_NUMBER" ]; then
              echo "‚ö†Ô∏è Could not extract PR number from URL: $PR_URL"
              # gh„Ç≥„Éû„É≥„Éâ„ÅßPRÁï™Âè∑„ÇíÂèñÂæó
              PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --base main --json number --jq '.[0].number' 2>/dev/null || echo "")
              if [ -z "$PR_NUMBER" ]; then
                echo "‚ùå Failed to extract PR number"
                exit 1
              fi
            fi
            echo "Created PR #$PR_NUMBER: $PR_URL"
          fi

          echo "Working with PR #$PR_NUMBER"

          # PR„Åå„Éû„Éº„Ç∏ÂèØËÉΩ„ÅãÁ¢∫Ë™çÔºà„É™„Éà„É©„Ç§„É≠„Ç∏„ÉÉ„ÇØ‰ªò„ÅçÔºâ
          echo "Checking if PR #$PR_NUMBER is mergeable..."

          # UNKNOWNÁä∂ÊÖã„ÅÆÂ†¥Âêà„ÄÅÊúÄÂ§ß5Âõû„É™„Éà„É©„Ç§ÔºàÂêÑ5ÁßíÂæÖÊ©üÔºâ
          MAX_RETRIES=5
          RETRY_COUNT=0
          MERGEABLE="UNKNOWN"

          while [ "$MERGEABLE" = "UNKNOWN" ] && [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if [ $RETRY_COUNT -gt 0 ]; then
              echo "Waiting for GitHub to determine mergeable status... (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
              sleep 5
            fi

            MERGEABLE=$(gh pr view $PR_NUMBER --json mergeable --jq '.mergeable' 2>/dev/null || echo "UNKNOWN")
            echo "Mergeable status: $MERGEABLE"
            RETRY_COUNT=$((RETRY_COUNT + 1))
          done

          # „Éû„Éº„Ç∏‰∏çÂèØ„ÅÆÂ†¥Âêà„ÄÅËá™Âãï‰øÆÂæ©„ÇíË©¶„Åø„Çã
          if [ "$MERGEABLE" = "CONFLICTING" ]; then
            echo "‚ö†Ô∏è PR has conflicts. Attempting auto-fix..."

            if auto_fix_branch "$BRANCH_NAME"; then
              echo "‚úÖ Auto-fix successful! Rechecking PR status..."
              sleep 5
              MERGEABLE=$(gh pr view $PR_NUMBER --json mergeable --jq '.mergeable' 2>/dev/null || echo "UNKNOWN")
              echo "New mergeable status: $MERGEABLE"
            else
              echo "‚ùå Auto-fix failed"
              ERROR_MSG="PR #$PR_NUMBER has conflicts that could not be auto-resolved"
              create_failure_issue "$BRANCH_NAME" "$ERROR_MSG"
              exit 1
            fi
          fi

          # „Åæ„Å†UNKNOWN„ÅÆÂ†¥Âêà„ÄÅ„Éû„Éº„Ç∏„ÇíË©¶„Åø„ÇãÔºàÂ§±Êïó„Åó„Åü„Çâ„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÅåÂá∫„ÇãÔºâ
          if [ "$MERGEABLE" = "UNKNOWN" ]; then
            echo "‚ö†Ô∏è Mergeable status is still UNKNOWN after $MAX_RETRIES attempts."
            echo "Attempting to merge anyway..."
          elif [ "$MERGEABLE" != "MERGEABLE" ]; then
            echo "‚ùå PR #$PR_NUMBER cannot be merged automatically."
            echo "Mergeable status: $MERGEABLE"
            echo "Possible reasons:"
            echo "  - The branch is behind main"
            echo "  - There are merge conflicts"
            echo "  - Required status checks are not passing"
            echo ""

            # ÊúÄÂæå„ÅÆË©¶„Åø: Âº∑Âà∂ÁöÑ„Å´Ëá™Âãï‰øÆÂæ©
            echo "üîß Making final auto-fix attempt..."
            if auto_fix_branch "$BRANCH_NAME"; then
              echo "‚úÖ Final auto-fix successful!"
              sleep 5
            else
              echo "‚ùå All auto-fix attempts exhausted"
              ERROR_MSG="PR #$PR_NUMBER cannot be merged. Status: $MERGEABLE"
              create_failure_issue "$BRANCH_NAME" "$ERROR_MSG"
              echo "Please check the PR: https://github.com/${{ github.repository }}/pull/$PR_NUMBER"
              exit 1
            fi
          fi

          # PR„Çí„Éû„Éº„Ç∏Ôºà„É™„Éà„É©„Ç§‰ªò„ÅçÔºâ
          echo "Merging PR #$PR_NUMBER..."
          if retry_command gh pr merge $PR_NUMBER --merge --delete-branch; then
            echo "‚úÖ PR merged successfully!"
          else
            echo "‚ùå Merge command failed"
            ERROR_MSG="Failed to execute merge command for PR #$PR_NUMBER"
            create_failure_issue "$BRANCH_NAME" "$ERROR_MSG"
            exit 1
          fi

          echo ""
          echo "========================================="
          echo "‚úÖ AUTO-MERGE COMPLETED SUCCESSFULLY"
          echo "========================================="
          echo "Branch: $BRANCH_NAME"
          echo "PR: #$PR_NUMBER"
          echo "Deployment will start automatically"
          echo "========================================="
