name: Auto PR and Merge with Auto-Fix

on:
  push:
    branches:
      - 'claude/**'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create Pull Request and Auto Merge with Auto-Fix
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ãƒªãƒˆãƒ©ã‚¤é–¢æ•°ï¼ˆæŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ä»˜ãï¼‰
          retry_command() {
            local max_retries=4
            local retry_delay=2
            local attempt=0
            local exit_code=0

            while [ $attempt -le $max_retries ]; do
              if [ $attempt -gt 0 ]; then
                echo "Retrying in ${retry_delay}s... (attempt $((attempt + 1))/$((max_retries + 1)))"
                sleep $retry_delay
                retry_delay=$((retry_delay * 2))
              fi

              "$@" && return 0
              exit_code=$?
              attempt=$((attempt + 1))
            done

            echo "âŒ Command failed after $((max_retries + 1)) attempts"
            return $exit_code
          }

          # è‡ªå‹•ä¿®å¾©é–¢æ•°
          auto_fix_branch() {
            local branch_name=$1
            echo "ğŸ”§ Attempting auto-fix for branch: $branch_name"

            # mainãƒ–ãƒ©ãƒ³ãƒã®æœ€æ–°ã‚’å–å¾—
            git fetch origin main

            # ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
            git checkout "$branch_name"

            # mainãƒ–ãƒ©ãƒ³ãƒã‚’rebaseã§çµ±åˆã‚’è©¦ã¿ã‚‹
            echo "Attempting to rebase onto main..."
            if git rebase origin/main; then
              echo "âœ… Rebase successful!"

              # å¼·åˆ¶ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆrebaseå¾Œã¯å¿…è¦ï¼‰
              if git push --force-with-lease origin "$branch_name"; then
                echo "âœ… Force-pushed rebased branch"
                return 0
              else
                echo "âŒ Failed to push rebased branch"
                return 1
              fi
            else
              echo "âš ï¸ Rebase failed, attempting merge strategy..."
              git rebase --abort

              # rebaseãŒå¤±æ•—ã—ãŸå ´åˆã€mergeã‚’è©¦ã¿ã‚‹
              if git merge origin/main -m "Auto-merge: Merge main into $branch_name"; then
                echo "âœ… Merge successful!"

                if git push origin "$branch_name"; then
                  echo "âœ… Pushed merged branch"
                  return 0
                else
                  echo "âŒ Failed to push merged branch"
                  return 1
                fi
              else
                echo "âŒ Merge also failed"

                # ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒã‚ã‚‹å ´åˆã€è‡ªå‹•è§£æ±ºã‚’è©¦ã¿ã‚‹ï¼ˆoursæˆ¦ç•¥ï¼‰
                echo "âš ï¸ Attempting conflict resolution with 'ours' strategy..."
                git merge --abort

                if git merge -X ours origin/main -m "Auto-merge: Resolve conflicts with ours strategy"; then
                  echo "âœ… Conflicts resolved with 'ours' strategy"

                  if git push origin "$branch_name"; then
                    echo "âœ… Pushed conflict-resolved branch"
                    return 0
                  fi
                fi

                echo "âŒ Auto-fix failed"
                return 1
              fi
            fi
          }

          # issueã‚’ä½œæˆã™ã‚‹é–¢æ•°
          create_failure_issue() {
            local branch_name=$1
            local error_message=$2

            echo "ğŸ“ Creating issue for merge failure..."

            gh issue create \
              --title "ğŸš¨ Auto-merge failed for branch: $branch_name" \
              --body "## Auto-merge Failure Report

**Branch**: \`$branch_name\`
**Time**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
**Workflow Run**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

### Error
\`\`\`
$error_message
\`\`\`

### What happened?
The auto-merge workflow failed to merge this branch into main.

### Recommended Actions
1. Check for merge conflicts: \`git checkout $branch_name && git merge main\`
2. Resolve conflicts manually if needed
3. Run tests to ensure everything works
4. Manually merge the PR: https://github.com/${{ github.repository }}/pulls

### Auto-fix Attempts
- âœ… Retry with exponential backoff
- âœ… Rebase onto main
- âœ… Merge with main
- âœ… Conflict resolution with 'ours' strategy
- âŒ All auto-fix attempts failed

**This issue was automatically created by GitHub Actions.**
" \
              --label "auto-merge-failure,bug"
          }

          # ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Current branch: $BRANCH_NAME"

          # æ—¢å­˜ã®PRã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
          echo "Checking for existing PRs..."
          EXISTING_PR=$(retry_command gh pr list --head "$BRANCH_NAME" --base main --json number --jq '.[0].number')

          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists"
            PR_NUMBER=$EXISTING_PR
          else
            echo "Creating new PR..."

            # PRä½œæˆå‰ã«mainã¨ã®å·®åˆ†ã‚’ãƒã‚§ãƒƒã‚¯
            git fetch origin main
            COMMITS_BEHIND=$(git rev-list --count HEAD..origin/main)

            if [ "$COMMITS_BEHIND" -gt 0 ]; then
              echo "âš ï¸ Branch is $COMMITS_BEHIND commits behind main"
              echo "Attempting to update branch before creating PR..."

              if ! auto_fix_branch "$BRANCH_NAME"; then
                echo "âŒ Failed to update branch"
                ERROR_MSG="Branch is behind main and auto-fix failed"
                create_failure_issue "$BRANCH_NAME" "$ERROR_MSG"
                exit 1
              fi
            fi

            PR_URL=$(retry_command gh pr create \
              --title "Auto-merge: $BRANCH_NAME" \
              --body "ã“ã®PRã¯è‡ªå‹•çš„ã«ä½œæˆãƒ»ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã™ã€‚

**Branch**: \`$BRANCH_NAME\`
**Changes**: Automated changes from Claude Code session

ãƒãƒ¼ã‚¸å¾Œã€GitHub Pagesã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚

---

### Auto-merge Status
- âœ… PR created automatically
- â³ Waiting for merge checks
- ğŸ”„ Will auto-merge when ready

**ã“ã®PRã¯è‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã¾ã—ãŸã€‚å•é¡ŒãŒã‚ã‚‹å ´åˆã¯æ‰‹å‹•ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚**
" \
              --base main \
              --head "$BRANCH_NAME")

            if [ -z "$PR_URL" ]; then
              echo "âŒ Failed to create PR"
              ERROR_MSG="Failed to create PR for branch $BRANCH_NAME"
              create_failure_issue "$BRANCH_NAME" "$ERROR_MSG"
              exit 1
            fi

            PR_NUMBER=$(echo $PR_URL | grep -oP '\d+$')
            echo "Created PR #$PR_NUMBER: $PR_URL"
          fi

          # PRãŒãƒãƒ¼ã‚¸å¯èƒ½ã‹ç¢ºèªï¼ˆãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ä»˜ãï¼‰
          echo "Checking if PR #$PR_NUMBER is mergeable..."

          # UNKNOWNçŠ¶æ…‹ã®å ´åˆã€æœ€å¤§5å›ãƒªãƒˆãƒ©ã‚¤ï¼ˆå„5ç§’å¾…æ©Ÿï¼‰
          MAX_RETRIES=5
          RETRY_COUNT=0
          MERGEABLE="UNKNOWN"

          while [ "$MERGEABLE" = "UNKNOWN" ] && [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if [ $RETRY_COUNT -gt 0 ]; then
              echo "Waiting for GitHub to determine mergeable status... (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
              sleep 5
            fi

            MERGEABLE=$(retry_command gh pr view $PR_NUMBER --json mergeable --jq '.mergeable' || echo "UNKNOWN")
            echo "Mergeable status: $MERGEABLE"
            RETRY_COUNT=$((RETRY_COUNT + 1))
          done

          # ãƒãƒ¼ã‚¸ä¸å¯ã®å ´åˆã€è‡ªå‹•ä¿®å¾©ã‚’è©¦ã¿ã‚‹
          if [ "$MERGEABLE" = "CONFLICTING" ]; then
            echo "âš ï¸ PR has conflicts. Attempting auto-fix..."

            if auto_fix_branch "$BRANCH_NAME"; then
              echo "âœ… Auto-fix successful! Rechecking PR status..."
              sleep 5
              MERGEABLE=$(retry_command gh pr view $PR_NUMBER --json mergeable --jq '.mergeable' || echo "UNKNOWN")
              echo "New mergeable status: $MERGEABLE"
            else
              echo "âŒ Auto-fix failed"
              ERROR_MSG="PR #$PR_NUMBER has conflicts that could not be auto-resolved"
              create_failure_issue "$BRANCH_NAME" "$ERROR_MSG"
              exit 1
            fi
          fi

          # ã¾ã UNKNOWNã®å ´åˆã€ãƒãƒ¼ã‚¸ã‚’è©¦ã¿ã‚‹ï¼ˆå¤±æ•—ã—ãŸã‚‰ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‡ºã‚‹ï¼‰
          if [ "$MERGEABLE" = "UNKNOWN" ]; then
            echo "âš ï¸ Mergeable status is still UNKNOWN after $MAX_RETRIES attempts."
            echo "Attempting to merge anyway..."
          elif [ "$MERGEABLE" != "MERGEABLE" ]; then
            echo "âŒ PR #$PR_NUMBER cannot be merged automatically."
            echo "Mergeable status: $MERGEABLE"
            echo "Possible reasons:"
            echo "  - The branch is behind main"
            echo "  - There are merge conflicts"
            echo "  - Required status checks are not passing"
            echo ""

            # æœ€å¾Œã®è©¦ã¿: å¼·åˆ¶çš„ã«è‡ªå‹•ä¿®å¾©
            echo "ğŸ”§ Making final auto-fix attempt..."
            if auto_fix_branch "$BRANCH_NAME"; then
              echo "âœ… Final auto-fix successful!"
              sleep 5
            else
              echo "âŒ All auto-fix attempts exhausted"
              ERROR_MSG="PR #$PR_NUMBER cannot be merged. Status: $MERGEABLE"
              create_failure_issue "$BRANCH_NAME" "$ERROR_MSG"
              echo "Please check the PR: https://github.com/${{ github.repository }}/pull/$PR_NUMBER"
              exit 1
            fi
          fi

          # PRã‚’ãƒãƒ¼ã‚¸ï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
          echo "Merging PR #$PR_NUMBER..."
          if retry_command gh pr merge $PR_NUMBER --merge --delete-branch; then
            echo "âœ… PR merged successfully!"
          else
            echo "âŒ Merge command failed"
            ERROR_MSG="Failed to execute merge command for PR #$PR_NUMBER"
            create_failure_issue "$BRANCH_NAME" "$ERROR_MSG"
            exit 1
          fi

          echo ""
          echo "========================================="
          echo "âœ… AUTO-MERGE COMPLETED SUCCESSFULLY"
          echo "========================================="
          echo "Branch: $BRANCH_NAME"
          echo "PR: #$PR_NUMBER"
          echo "Deployment will start automatically"
          echo "========================================="
