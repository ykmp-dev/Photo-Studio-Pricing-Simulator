# FormBuilder V3 テストチェックリスト

## 📋 テスト前の準備

### 1. データの準備
- [ ] 管理画面にログイン
- [ ] カテゴリ管理タブで以下が登録されていることを確認:
  - 撮影カテゴリ: 「七五三」など
  - 商品カテゴリ: 「撮影プラン」「アルバムパッケージ」「ヘアメイク」など
  - アイテム: 各商品カテゴリに複数のアイテムが登録されている

### 2. ブラウザ準備
- [ ] ブラウザのコンソールを開く（F12 → Consoleタブ）
- [ ] コンソールをクリアしておく

---

## ✅ 機能1: FormBuilderステップの編集機能

### テスト手順

#### A. Trigger（最初に選ぶ項目）の編集

1. **編集ボタンの表示確認**
   - [ ] フォームビルダータブで七五三カテゴリのフォームを開く
   - [ ] Step 1「最初に選ぶ項目」で追加済み項目の横に「編集」ボタンが表示される

2. **編集モードの動作**
   - [ ] 「編集」ボタンをクリック
   - [ ] 該当項目の背景が黄色になり「編集中...」と表示される
   - [ ] フォームに既存データが自動入力される（商品カテゴリ、選択方法が選択済み）
   - [ ] タイトルが「項目を編集」に変わる
   - [ ] 他の項目の「編集」「削除」ボタンが無効化される

3. **編集の実行**
   - [ ] product_typeを変更（例: 丸ボタン → プルダウン）
   - [ ] 「更新」ボタン（黄色）をクリック
   - [ ] 項目が更新される
   - [ ] 編集モードが解除され、背景が青に戻る

4. **編集のキャンセル**
   - [ ] 再度「編集」ボタンをクリック
   - [ ] 「編集をキャンセル」ボタンをクリック
   - [ ] フォームがリセットされ、編集モードが解除される

#### B. Conditional（分岐設定）の編集

1. **編集ボタンの表示確認**
   - [ ] Step 2「分岐設定」で追加済み分岐設定の横に「編集」ボタンが表示される

2. **編集モードの動作**
   - [ ] 「編集」ボタンをクリック
   - [ ] 該当項目の背景が黄色になる
   - [ ] フォームに既存データが自動入力される（商品カテゴリ、条件設定が選択済み）
   - [ ] タイトルが「分岐設定を編集」に変わる

3. **条件の変更**
   - [ ] 表示条件を変更（例: 「ベーシックプラン」→「スタンダードプラン」）
   - [ ] 「更新」ボタンをクリック
   - [ ] 分岐設定が更新される

#### C. CommonFinal（いつも表示）の編集

1. **編集ボタンの表示確認**
   - [ ] Step 3「いつも表示」で追加済み項目の横に「編集」ボタンが表示される

2. **編集モードの動作**
   - [ ] 「編集」ボタンをクリック
   - [ ] 該当項目の背景が黄色になる
   - [ ] フォームに既存データが自動入力される

3. **編集の実行**
   - [ ] product_typeを変更
   - [ ] 「更新」ボタンをクリック
   - [ ] 項目が更新される

### 期待される結果

✅ **正常な動作**:
- 編集ボタンをクリックすると既存データがフォームに入る
- 更新ボタンで変更が保存される
- 編集中は他の項目の操作が無効化される
- キャンセルボタンで編集モードを解除できる

❌ **問題が発生した場合の修正依頼**:

| 問題 | 修正依頼例 |
|------|-----------|
| 編集ボタンをクリックしてもフォームに値が入らない | 「編集ボタンをクリックしても、フォームが空のままです。既存データの読み込みを修正してください」 |
| 更新ボタンをクリックしても変更が反映されない | 「更新ボタンを押しても項目が更新されません。ステップ更新ロジックを確認してください」 |
| 編集中に他の項目も編集できてしまう | 「編集中に他の編集・削除ボタンが無効化されていません。disabledロジックを修正してください」 |
| 編集をキャンセルしてもフォームがリセットされない | 「キャンセルボタンを押してもフォームに値が残ったままです。handleCancelEditの実装を確認してください」 |

---

## ✅ 機能2: 条件分岐の表示ロジック

### テスト手順

#### A. 条件分岐の設定（管理画面）

1. **FormBuilderで条件を設定**
   - [ ] 七五三フォームを開く
   - [ ] Step 1で「撮影プラン」カテゴリを追加（アイテム例: 3歳プラン、7歳プラン）
   - [ ] Step 2で「ヘアメイク」カテゴリを追加
   - [ ] 条件設定: 「撮影プラン」で「3歳プラン」を選んだ時
   - [ ] 「更新（本番に反映）」ボタンをクリック

2. **デバッグログの確認**
   - [ ] ブラウザコンソールを開く
   - [ ] 条件ルールが表示される（例: `[条件] ヘアメイク: { AND: [...] }`）
   - [ ] 条件の`value`が**数値**（アイテムID）になっていることを確認

```javascript
// 期待されるログ例
[条件] ヘアメイク: {
  AND: [
    {
      field: "category_123",  // カテゴリID
      operator: "=",
      value: 456              // ← これが数値であることが重要！
    }
  ]
}
```

#### B. 条件分岐の動作確認（顧客フォーム）

1. **初期表示**
   - [ ] 顧客フォーム（GitHub Pages）を開く
   - [ ] 七五三を選択
   - [ ] 「撮影プラン」セクションが表示される
   - [ ] 「ヘアメイク」セクションは**表示されない**

2. **条件を満たす選択をする**
   - [ ] 「3歳プラン」を選択
   - [ ] コンソールに以下のログが出力される:
     - `formValues: { category_123: 456 }` ← アイテムIDが数値で保存されている
   - [ ] 「ヘアメイク」セクションが**自動的に表示される**

3. **条件を満たさない選択をする**
   - [ ] 「7歳プラン」を選択
   - [ ] 「ヘアメイク」セクションが**非表示になる**

### 期待される結果

✅ **正常な動作**:
- 条件を満たす選択をすると、分岐設定のセクションが表示される
- 条件を満たさない選択をすると、分岐設定のセクションが非表示になる
- コンソールログで`value`が数値であることが確認できる

❌ **問題が発生した場合の修正依頼**:

| 問題 | コンソールログで確認すべきこと | 修正依頼例 |
|------|------------------------------|-----------|
| 条件を満たしても表示されない | `[条件]`ログの`value`が文字列になっている | 「条件ルールのvalueが文字列（"3歳プラン"）になっています。formBuilderConverter.tsでアイテムIDへの変換が動いていないようです」 |
| 条件を満たしても表示されない | `formValues`のキーが`category_123`ではなく別の値 | 「formValuesのキーが `{キー名}` になっています。条件ルールのfieldと一致していません」 |
| 常に表示される/常に非表示 | `conditional_rule`が`null` | 「条件ルールがnullです。formBuilderConverterで条件ルール生成時にエラーが発生している可能性があります」 |
| コンソールに警告が出る | `条件ルールの変換エラー:...` | 「コンソールに『条件ルールの変換エラー: カテゴリ X にアイテム "Y" が見つかりません』と表示されます。マップ生成ロジックを確認してください」 |

### トラブルシューティング用のコンソールコマンド

```javascript
// 現在のformValuesを確認
// コンソールに表示されている formValues をコピー

// productCategoriesの条件ルールを確認
// コンソールに表示されている [条件] ログを確認

// 手動で条件評価をテスト
const formValues = { category_123: 456 }  // コンソールから取得
const rule = { /* コンソールから取得した条件ルール */ }
// 期待: category_123のフィールド値(456)と条件のvalue(456)が一致する
```

---

## ✅ 機能3: 「いつも表示」の表示タイミング

### テスト手順

#### パターンA: 分岐設定がない場合

1. **準備**
   - [ ] FormBuilderで七五三フォームを開く
   - [ ] Step 1「撮影プラン」のみ追加
   - [ ] Step 2「分岐設定」は何も追加しない
   - [ ] Step 3「いつも表示」で「データ納品」を追加
   - [ ] 「更新（本番に反映）」をクリック

2. **顧客フォームで確認**
   - [ ] 七五三を選択
   - [ ] 「撮影プラン」セクションが表示される
   - [ ] 「追加オプション」セクションが**すぐに表示される**（分岐設定がないため）

#### パターンB: 分岐設定がある場合

1. **準備**
   - [ ] FormBuilderで七五三フォームを開く
   - [ ] Step 1「撮影プラン」を追加（3歳プラン、7歳プラン）
   - [ ] Step 2「ヘアメイク」を追加、条件: 3歳プラン選択時
   - [ ] Step 3「データ納品」を追加
   - [ ] 「更新（本番に反映）」をクリック

2. **初期表示の確認**
   - [ ] 七五三を選択
   - [ ] 「撮影プラン」セクションが表示される
   - [ ] まだ何も選択していない状態では「追加オプション」は**表示されない**

3. **条件を満たす選択をする**
   - [ ] 「3歳プラン」を選択
   - [ ] 「ヘアメイク」セクション（分岐設定）が表示される
   - [ ] 同時に「追加オプション」セクションも**表示される**

4. **条件を満たさない選択をする**
   - [ ] 「7歳プラン」を選択
   - [ ] 「ヘアメイク」セクションが非表示になる
   - [ ] しかし「追加オプション」セクションは**表示されたまま**（一度でも分岐が表示されたため）

### 期待される結果

✅ **正常な動作**:

| 状況 | 期待される表示タイミング |
|------|------------------------|
| 分岐設定なし | 撮影カテゴリ選択後すぐに表示 |
| 分岐設定あり | 分岐設定が1つでも表示された後に表示 |

❌ **問題が発生した場合の修正依頼**:

| 問題 | 修正依頼例 |
|------|-----------|
| 分岐設定がないのに最初から表示されない | 「分岐設定がない場合でも『追加オプション』が表示されません。shouldShowCommonFinalのロジックを確認してください」 |
| 分岐設定があるのに最初から表示される | 「分岐設定がある場合、選択前から『追加オプション』が表示されています。hasVisibleConditionalの評価が正しくありません」 |
| 分岐が表示されても「追加オプション」が出ない | 「3歳プランを選択してヘアメイクが表示されましたが、『追加オプション』が出ません。shouldShowCommonFinalがfalseのままです」 |

### デバッグ用コンソールコマンド

```javascript
// ブラウザコンソールで以下を確認
// hasConditionalSections: 分岐設定が存在するか
// hasVisibleConditional: 現在分岐設定が表示されているか
// shouldShowCommonFinal: 追加オプションを表示すべきか

// コンソールログから確認:
// productCategories の中で form_section === 'conditional' が存在するか
// visibleCategories の中で form_section === 'conditional' が存在するか
```

---

## 🔧 全体的なトラブルシューティング

### コンソールエラーがある場合

1. **エラーメッセージを確認**
   ```
   エラーが発生している場合の依頼例:
   「ブラウザコンソールに以下のエラーが表示されます:
   [エラーメッセージをコピー]
   このエラーを修正してください」
   ```

2. **警告メッセージを確認**
   ```
   警告が表示されている場合の依頼例:
   「コンソールに以下の警告が出ます:
   [警告メッセージをコピー]
   この警告の原因を調査して修正してください」
   ```

### データが正しく保存されない場合

```
依頼例:
「フォームビルダーで更新ボタンを押しましたが、
顧客フォームに反映されません。以下を確認してください:
1. データベースに正しく保存されているか
2. 顧客フォームでデータを正しく取得しているか
3. キャッシュの問題ではないか」
```

### GitHub Pagesのデプロイ確認

```
依頼例:
「GitHub Pagesにデプロイされているか確認したいです。
最新のコミットハッシュを教えてください。
また、デプロイ状況を確認する方法を教えてください」
```

---

## 📝 テスト結果の報告テンプレート

### 成功時

```
テスト完了しました！以下すべて正常に動作しています:
✅ FormBuilderステップの編集機能
✅ 条件分岐の表示ロジック
✅ 「いつも表示」の表示タイミング

特に問題ありませんでした。
```

### 問題発生時

```
以下の問題が発生しました:

【問題1】編集機能のフォーム入力
- 再現手順: [具体的な手順]
- 期待される動作: [期待していたこと]
- 実際の動作: [実際に起こったこと]
- コンソールログ: [エラーや警告があればコピー]
- スクリーンショット: [可能であれば添付]

【問題2】条件分岐が表示されない
- 選択したプラン: 3歳プラン
- 表示されるはずのセクション: ヘアメイク
- コンソールログ:
  formValues: { category_123: "3歳プラン" }  ← 文字列になっている！
  [条件] ヘアメイク: { AND: [{ field: "category_123", operator: "=", value: 456 }] }
```

---

## 🎯 クイックリファレンス

### すぐに確認すべきコンソールログ

1. `formValues:` - ユーザーの選択値（アイテムIDが数値であることを確認）
2. `[条件] XXX:` - 条件ルールのvalue（数値であることを確認）
3. `productCategories:` - カテゴリのform_section, conditional_ruleを確認
4. `visibleCategories:` - 現在表示されているカテゴリを確認

### よくある問題と対処法

| 症状 | 原因 | 対処法 |
|------|------|--------|
| 編集ボタンがない | コンポーネントが古い | ブラウザキャッシュをクリア |
| 条件が機能しない | valueの型不一致 | コンソールログでvalueが数値か確認 |
| 追加オプションが表示されない | タイミングロジックの問題 | hasVisibleConditionalをコンソールで確認 |
| データが保存されない | ネットワークエラー | ネットワークタブでエラーを確認 |
