# v3ãƒ•ã‚©ãƒ¼ãƒ ãƒ“ãƒ«ãƒ€ãƒ¼å®Ÿè£…ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

## ðŸ“‹ æ¦‚è¦

TDDï¼ˆãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºï¼‰æ–¹å¼ã§ã€v3ä»•æ§˜æ›¸ã«åŸºã¥ã„ãŸæ’®å½±ãƒ—ãƒ©ãƒ³æ–™é‡‘ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚

**å®Ÿè£…çµæžœ: âœ… 37ãƒ†ã‚¹ãƒˆå…¨é€šéŽã€ãƒ“ãƒ«ãƒ‰æˆåŠŸ**

## ðŸŽ¯ å®Ÿè£…å†…å®¹

### Phase 1-4: ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆTDDæ–¹å¼ï¼‰

#### Phase 1: æ¡ä»¶ãƒ«ãƒ¼ãƒ«è©•ä¾¡ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆ15ãƒ†ã‚¹ãƒˆï¼‰
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/utils/conditionalRuleEngine.ts`
- **æ©Ÿèƒ½**: AND/ORå¯¾å¿œã®JSONæ¡ä»¶ãƒ«ãƒ¼ãƒ«è©•ä¾¡
- **å¯¾å¿œæ¼”ç®—å­**: `=`, `!=`, `IN`, `NOT_IN`, `>`, `>=`, `<`, `<=`
- **ç‰¹å¾´**: ãƒã‚¹ãƒˆã•ã‚ŒãŸANDæ¡ä»¶ã®ã‚µãƒãƒ¼ãƒˆ

```typescript
// ä½¿ç”¨ä¾‹
const rule = {
  "OR": [
    {
      "AND": [
        { "field": "plan_type", "operator": "=", "value": "studio" },
        { "field": "basic_option", "operator": "=", "value": "weekday" }
      ]
    },
    { "field": "plan_type", "operator": "=", "value": "on_location" }
  ]
}
const isMatch = evaluateConditionalRule(rule, formValues)
```

#### Phase 2: UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒžãƒƒãƒ”ãƒ³ã‚°ï¼ˆ3ãƒ†ã‚¹ãƒˆï¼‰
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/utils/formHelpers.ts`
- **æ©Ÿèƒ½**: product_type â†’ UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è‡ªå‹•ãƒžãƒƒãƒ”ãƒ³ã‚°

| product_type | UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ |
|--------------|------------------|
| `plan` | ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ï¼ˆå˜ä¸€é¸æŠžï¼‰ |
| `option_single` | ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆå˜ä¸€é¸æŠžï¼‰ |
| `option_multi` | ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼ˆè¤‡æ•°é¸æŠžï¼‰ |

#### Phase 3: åˆè¨ˆé‡‘é¡è¨ˆç®—ï¼ˆ6ãƒ†ã‚¹ãƒˆï¼‰
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/utils/formHelpers.ts`
- **æ©Ÿèƒ½**: v3ä»•æ§˜æ›¸æº–æ‹ ã®ç¨Žè¾¼è¨ˆç®—
- **è¨ˆç®—å¼**: `total = Math.floor(subtotal * 1.10)`
- **ç‰¹å¾´**: ç«¯æ•°åˆ‡ã‚Šæ¨ã¦ã€é‡è¤‡IDé™¤åŽ»ã€å­˜åœ¨ã—ãªã„IDç„¡è¦–

#### Phase 4: ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ13ãƒ†ã‚¹ãƒˆï¼‰
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/utils/sectionLogic.ts`
- **æ©Ÿèƒ½**: form_section ã«ã‚ˆã‚‹è¡¨ç¤ºåˆ¶å¾¡

| form_section | è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ |
|--------------|--------------|
| `trigger` | å¸¸ã«è¡¨ç¤ºï¼ˆã‚³ãƒ¼ã‚¹é¸æŠžãªã©ï¼‰ |
| `conditional` | æ¡ä»¶ãƒ«ãƒ¼ãƒ«è©•ä¾¡å¾Œã€ãƒžãƒƒãƒæ™‚ã®ã¿è¡¨ç¤º |
| `common_final` | å¸¸ã«è¡¨ç¤ºï¼ˆè¿½åŠ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ |

### Phase 5: DBãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

**ãƒ•ã‚¡ã‚¤ãƒ«**: `supabase/migrations/017_add_v3_form_fields.sql`

`product_categories` ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š
- `form_section VARCHAR(50)` - ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—
- `product_type VARCHAR(50)` - å•†å“ã‚¿ã‚¤ãƒ—
- `conditional_rule JSONB` - æ¡ä»¶ãƒ«ãƒ¼ãƒ«ï¼ˆJSONå½¢å¼ï¼‰

ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆä¸ƒäº”ä¸‰ï¼‰ã‚‚å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

### Phase 6: é¡§å®¢å‘ã‘ãƒ•ã‚©ãƒ¼ãƒ ãƒšãƒ¼ã‚¸

**ãƒ•ã‚¡ã‚¤ãƒ«**:
- `frontend/src/pages/CustomerFormPageV3.tsx` - ãƒ¡ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ãƒšãƒ¼ã‚¸
- `frontend/src/components/customer/ProductCategorySection.tsx` - å•†å“ã‚«ãƒ†ã‚´ãƒªã‚»ã‚¯ã‚·ãƒ§ãƒ³

**æ©Ÿèƒ½**:
- æ’®å½±ã‚«ãƒ†ã‚´ãƒªé¸æŠž
- ãƒ‘ã‚¿ãƒ¼ãƒ³A/Bå¯¾å¿œï¼ˆTriggerã‚ã‚Š/ãªã—ï¼‰
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆè¨ˆé‡‘é¡è¡¨ç¤ºï¼ˆç¨Žè¾¼ï¼‰
- æ¡ä»¶ã«åŸºã¥ãå‹•çš„ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º

**ã‚¢ã‚¯ã‚»ã‚¹**: `/form/v3/:shopId`

### Phase 7: ç®¡ç†ç”»é¢UIæ‹¡å¼µ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/components/admin/CategoryManager.tsx`

å•†å“ã‚«ãƒ†ã‚´ãƒªç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã«v3ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ï¼š
- **ãƒ•ã‚©ãƒ¼ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³**: ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ï¼ˆtrigger/conditional/common_finalï¼‰
- **å•†å“ã‚¿ã‚¤ãƒ—**: ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ï¼ˆplan/option_single/option_multiï¼‰
- **æ¡ä»¶ãƒ«ãƒ¼ãƒ«**: ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ï¼ˆJSONå…¥åŠ›ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰

## ðŸ§ª ãƒ†ã‚¹ãƒˆç’°å¢ƒ

**ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ¸ˆã¿**:
- Vitest + @testing-library/react
- `vitest.config.ts` è¨­å®šå®Œäº†
- `npm test` / `npm run test:ui` / `npm run test:run` ã‚³ãƒžãƒ³ãƒ‰ä½¿ç”¨å¯èƒ½

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**:
- `frontend/src/utils/conditionalRuleEngine.test.ts`
- `frontend/src/utils/formHelpers.test.ts`
- `frontend/src/utils/sectionLogic.test.ts`

## ðŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
frontend/src/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ customer/
â”‚   â”‚   â””â”€â”€ ProductCategorySection.tsx  # å•†å“ã‚«ãƒ†ã‚´ãƒªUIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â””â”€â”€ admin/
â”‚       â””â”€â”€ CategoryManager.tsx         # ç®¡ç†ç”»é¢ï¼ˆv3ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¯¾å¿œï¼‰
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ CustomerFormPageV3.tsx          # é¡§å®¢å‘ã‘ãƒ•ã‚©ãƒ¼ãƒ ãƒšãƒ¼ã‚¸
â”œâ”€â”€ types/
â”‚   â”œâ”€â”€ formV3.ts                       # v3åž‹å®šç¾©
â”‚   â””â”€â”€ category.ts                     # ã‚«ãƒ†ã‚´ãƒªåž‹å®šç¾©ï¼ˆv3ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ ï¼‰
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ conditionalRuleEngine.ts        # æ¡ä»¶è©•ä¾¡ã‚¨ãƒ³ã‚¸ãƒ³
â”‚   â”œâ”€â”€ formHelpers.ts                  # UIãƒžãƒƒãƒ”ãƒ³ã‚°ãƒ»é‡‘é¡è¨ˆç®—
â”‚   â””â”€â”€ sectionLogic.ts                 # ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯
â””â”€â”€ test/
    â””â”€â”€ setup.ts                        # Vitestã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

supabase/migrations/
â””â”€â”€ 017_add_v3_form_fields.sql          # DBãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
```

## ðŸš€ ä½¿ç”¨æ–¹æ³•

### ç®¡ç†ç”»é¢ã§ã®è¨­å®š

1. `/admin` ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³
2. ã€Œã‚«ãƒ†ã‚´ãƒªãƒ»ã‚¢ã‚¤ãƒ†ãƒ ç®¡ç†ã€ã‚¿ãƒ–ã‚’é–‹ã
3. ã€Œå•†å“ã‚«ãƒ†ã‚´ãƒªç®¡ç†ã€ãƒ“ãƒ¥ãƒ¼ã‚’é¸æŠž
4. å•†å“ã‚«ãƒ†ã‚´ãƒªã‚’ä½œæˆãƒ»ç·¨é›†æ™‚ã«ã€Œv3ãƒ•ã‚©ãƒ¼ãƒ è¨­å®šã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§è¨­å®šï¼š
   - **ãƒ•ã‚©ãƒ¼ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³**: trigger/conditional/common_final ã‚’é¸æŠž
   - **å•†å“ã‚¿ã‚¤ãƒ—**: plan/option_single/option_multi ã‚’é¸æŠž
   - **æ¡ä»¶ãƒ«ãƒ¼ãƒ«**: JSONå½¢å¼ã§æ¡ä»¶ã‚’è¨˜è¿°ï¼ˆconditionalã®å ´åˆï¼‰

### é¡§å®¢å‘ã‘ãƒ•ã‚©ãƒ¼ãƒ 

`/form/v3/:shopId` ã«ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆä¾‹: `/form/v3/1`ï¼‰

**ãƒ•ãƒ­ãƒ¼**:
1. æ’®å½±ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠžï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼‰
2. Triggerã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠž â†’ æ¡ä»¶è©•ä¾¡
4. æ¡ä»¶ã«ãƒžãƒƒãƒã—ãŸConditionalã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º
5. Common Finalã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºï¼ˆå¸¸ã«ï¼‰
6. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§åˆè¨ˆé‡‘é¡ï¼ˆç¨Žè¾¼ï¼‰ã‚’è¡¨ç¤º

## ðŸ“ æ¡ä»¶ãƒ«ãƒ¼ãƒ«ã®ä¾‹

### ä¾‹1: å˜ç´”ãªANDæ¡ä»¶
```json
{
  "AND": [
    { "field": "plan_type", "operator": "=", "value": "studio" },
    { "field": "basic_option", "operator": "=", "value": "weekday" }
  ]
}
```

### ä¾‹2: INæ¼”ç®—å­
```json
{
  "AND": [
    { "field": "plan_type", "operator": "IN", "value": ["studio", "on_location"] }
  ]
}
```

### ä¾‹3: AND + OR è¤‡åˆæ¡ä»¶
```json
{
  "OR": [
    {
      "AND": [
        { "field": "plan_type", "operator": "=", "value": "studio" },
        { "field": "basic_option", "operator": "=", "value": "weekday" }
      ]
    },
    { "field": "plan_type", "operator": "=", "value": "on_location" }
  ]
}
```

## âœ… v3ä»•æ§˜æ›¸ã¨ã®å¯¾å¿œè¡¨

| ä»•æ§˜é …ç›® | å®Ÿè£…çŠ¶æ³ | å‚™è€ƒ |
|---------|---------|------|
| ãƒ‘ã‚¿ãƒ¼ãƒ³A/Bå¯¾å¿œ | âœ… | Triggeræœ‰ç„¡ã®è‡ªå‹•åˆ¤å®š |
| Trigger/Conditional/Common Final | âœ… | ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ†é›¢å®Ÿè£… |
| AND/ORæ¡ä»¶ãƒ«ãƒ¼ãƒ« | âœ… | ãƒã‚¹ãƒˆå¯¾å¿œ |
| UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè‡ªå‹•ãƒžãƒƒãƒ”ãƒ³ã‚° | âœ… | radio/select/checkbox |
| ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆè¨ˆé‡‘é¡ | âœ… | ç¨Žè¾¼10%ã€ç«¯æ•°åˆ‡ã‚Šæ¨ã¦ |
| DBã‚¹ã‚­ãƒ¼ãƒžæ‹¡å¼µ | âœ… | ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³+ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ |
| ç®¡ç†ç”»é¢UI | âœ… | CategoryManageræ‹¡å¼µ |
| ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ | âœ… | 37ãƒ†ã‚¹ãƒˆå…¨é€šéŽ |

## ðŸ”§ é–‹ç™ºã‚³ãƒžãƒ³ãƒ‰

```bash
# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
npm test

# ãƒ†ã‚¹ãƒˆUIèµ·å‹•
npm run test:ui

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆCIå‘ã‘ï¼‰
npm run test:run

# ãƒ“ãƒ«ãƒ‰
npm run build

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
npm run dev
```

## ðŸ“š å‚è€ƒè³‡æ–™

- v3ä»•æ§˜æ›¸: æ’®å½±ãƒ—ãƒ©ãƒ³æ–™é‡‘ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ ä»•æ§˜æ›¸ï¼ˆv3ï¼‰
- DBãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: `supabase/migrations/017_add_v3_form_fields.sql`
- åž‹å®šç¾©: `frontend/src/types/formV3.ts`

---

**å®Ÿè£…å®Œäº†æ—¥**: 2025-12-19
**ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºï¼ˆTDDï¼‰æ–¹å¼ã§å…¨æ©Ÿèƒ½å®Ÿè£…**
**37ãƒ†ã‚¹ãƒˆå…¨é€šéŽã€ãƒ“ãƒ«ãƒ‰æˆåŠŸ**
